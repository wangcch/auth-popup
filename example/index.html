<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AuthPopup Demo - GitHub OAuth</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
      background: #f6f8fa;
      color: #24292f;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: #ffffff;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      padding: 32px;
      max-width: 900px;
      width: 100%;
      box-shadow: 0 1px 3px rgba(27, 31, 35, 0.12), 0 8px 24px rgba(66, 74, 83, 0.12);
    }

    .providers-section {
      margin-bottom: 24px;
    }

    .providers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .provider-card {
      border: 1px solid #d0d7de;
      border-radius: 6px;
      padding: 20px;
      background: #f6f8fa;
      transition: all 0.2s;
    }

    .provider-card:hover {
      box-shadow: 0 3px 8px rgba(27, 31, 35, 0.15);
      border-color: #0969da;
    }

    .provider-logo {
      width: 32px;
      height: 32px;
      margin-bottom: 12px;
    }

    .header {
      text-align: center;
      margin-bottom: 32px;
    }

    .logo {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      fill: #0969da;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      color: #24292f;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 14px;
      color: #57606a;
    }

    .oauth-section {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #24292f;
      margin-bottom: 8px;
    }

    .input-group {
      margin-bottom: 16px;
    }

    input[type="text"] {
      width: 100%;
      padding: 5px 12px;
      background: #ffffff;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      color: #24292f;
      font-size: 14px;
      font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, 'Liberation Mono', monospace;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #0969da;
      box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.3);
    }

    input[type="text"]::placeholder {
      color: #57606a;
    }

    .help-text {
      font-size: 12px;
      color: #57606a;
      margin-top: 8px;
      line-height: 1.5;
    }

    .help-text a {
      color: #0969da;
      text-decoration: none;
    }

    .help-text a:hover {
      text-decoration: underline;
    }

    .help-text code {
      background: #f6f8fa;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      font-family: ui-monospace, SFMono-Regular, monospace;
    }

    button {
      width: 100%;
      padding: 5px 16px;
      background: #238636;
      color: white;
      border: 1px solid rgba(240, 246, 252, 0.1);
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      background: #2ea043;
    }

    button:active {
      background: #238636;
    }

    button:disabled {
      background: #94d3a2;
      color: #ffffff;
      cursor: not-allowed;
      border-color: #94d3a2;
    }

    button svg {
      width: 16px;
      height: 16px;
    }

    /* Provider-specific button styles */
    button.github-btn {
      background: #24292f;
    }

    button.github-btn:hover:not(:disabled) {
      background: #32383f;
    }

    button.feishu-btn {
      background: #3370ff;
    }

    button.feishu-btn:hover:not(:disabled) {
      background: #2860e0;
    }

    button.feishu-auth-btn {
      background: #00b42a;
    }

    button.feishu-auth-btn:hover:not(:disabled) {
      background: #009a29;
    }

    button.google-btn {
      background: #4285f4;
    }

    button.google-btn:hover:not(:disabled) {
      background: #357ae8;
    }

    .provider-name {
      font-size: 16px;
      font-weight: 600;
      color: #24292f;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .provider-desc {
      font-size: 12px;
      color: #57606a;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .result {
      margin-top: 24px;
      padding: 20px;
      border-radius: 6px;
      border: 1px solid #d0d7de;
      display: none;
      font-size: 14px;
    }

    .result.show {
      display: block;
    }

    .result.success {
      background: #dafbe1;
      border-color: #1a7f37;
      color: #0f5323;
    }

    .result.error {
      background: #ffebe9;
      border-color: #cf222e;
      color: #a40e26;
    }

    .result-title {
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
    }

    .result.success .result-title {
      color: #1a7f37;
    }

    .result.error .result-title {
      color: #cf222e;
    }

    .result-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 12px;
    }

    @media (max-width: 768px) {
      .result-layout {
        grid-template-columns: 1fr;
      }
    }

    .result-content {
      font-family: ui-monospace, SFMono-Regular, monospace;
      font-size: 11px;
      color: #c9d1d9;
      white-space: pre-wrap;
      word-break: break-all;
      background: #1c2128;
      padding: 16px;
      border-radius: 6px;
      line-height: 1.6;
    }

    .result-message {
      font-size: 14px;
      color: #24292f;
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 6px;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .result.error .result-message {
      color: #cf222e;
      background: rgba(248, 81, 73, 0.15);
      border-left: 3px solid #f85149;
      font-weight: 500;
    }

    .json-title {
      font-size: 11px;
      font-weight: 600;
      color: #8b949e;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .user-card {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 20px;
      background: #ffffff;
      border: 1px solid #d0d7de;
      border-radius: 6px;
    }

    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 2px solid #d0d7de;
      flex-shrink: 0;
    }

    .user-info {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      font-size: 18px;
      font-weight: 600;
      color: #24292f;
      margin-bottom: 4px;
    }

    .user-login {
      font-size: 14px;
      color: #57606a;
      margin-bottom: 8px;
    }

    .user-bio {
      font-size: 13px;
      color: #57606a;
      line-height: 1.5;
    }

    .next-steps {
      margin-top: 12px;
      padding: 12px;
      background: #fff8c5;
      border: 1px solid #d4a72c;
      border-radius: 6px;
      font-size: 12px;
      color: #6f5c00;
    }

    .next-steps code {
      background: #fcf0c0;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: ui-monospace, SFMono-Regular, monospace;
    }

    .info-section {
      margin-top: 32px;
    }

    .section-heading {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 600;
      color: #0969da;
      margin-bottom: 16px;
    }

    .section-heading svg {
      width: 20px;
      height: 20px;
      fill: #0969da;
    }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    @media (max-width: 768px) {
      .features-grid {
        grid-template-columns: 1fr;
      }
    }

    .feature-card {
      padding: 20px;
      background: #f6f8fa;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .feature-card:hover {
      border-color: #0969da;
      box-shadow: 0 3px 8px rgba(27, 31, 35, 0.15);
    }

    .feature-icon {
      width: 40px;
      height: 40px;
      background: #ddf4ff;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
    }

    .feature-icon svg {
      width: 20px;
      height: 20px;
      fill: #0969da;
    }

    .feature-title {
      font-size: 14px;
      font-weight: 600;
      color: #24292f;
      margin-bottom: 8px;
    }

    .feature-desc {
      font-size: 12px;
      color: #57606a;
      line-height: 1.6;
    }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>AuthPopup Demo</h1>
      <p class="subtitle">OAuth 2.0 Popup Authorization</p>
    </div>

    <div class="providers-section">
      <div class="providers-grid">
        <!-- GitHub Provider -->
        <div class="provider-card">
          <div class="provider-name">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
              <path
                d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
            </svg>
            GitHub
          </div>
          <div class="provider-desc">Sign in with your GitHub account</div>
          <div class="input-group">
            <input type="text" id="github-client-id" placeholder="Client ID (optional for demo)" />
            <div class="help-text">
              üîó <a href="https://github.com/settings/developers" target="_blank">Create OAuth App</a><br>
              üìã Callback URL: <code>http://localhost:8000/examples/callback-local.html</code>
            </div>
          </div>
          <button id="github-btn" class="github-btn" onclick="loginWithGitHub()">
            <svg fill="currentColor" viewBox="0 0 16 16">
              <path
                d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
            </svg>
            <span>Sign in</span>
          </button>
        </div>

        <!-- Feishu Provider -->
        <div class="provider-card">
          <div class="provider-name">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M12.9238 12.8029C12.9427 12.784 12.9616 12.7682 12.9806 12.7493C13.0184 12.7146 13.0563 12.6767 13.091 12.6389L13.1667 12.5631L13.397 12.336L14.7315 11.0173L15.0659 10.686C15.129 10.6229 15.1952 10.563 15.2615 10.5031C15.3845 10.3926 15.5076 10.2854 15.6369 10.1813C15.7536 10.0866 15.8767 9.99514 15.9997 9.9068C16.1732 9.78376 16.3499 9.67019 16.5329 9.55977C16.7127 9.45251 16.8957 9.35471 17.085 9.26322C17.2616 9.17804 17.4415 9.09917 17.6276 9.02661C17.7317 8.9856 17.8326 8.94774 17.9399 8.91304C17.9935 8.89411 18.044 8.87834 18.0977 8.86256C17.6276 7.00439 16.7632 5.3008 15.5991 3.84959C15.3719 3.56566 15.0249 3.40161 14.6589 3.40161H5.0084C4.83489 3.40161 4.76233 3.6256 4.90114 3.72656C8.18528 6.13997 10.9236 9.24114 12.9017 12.825C12.908 12.8187 12.9175 12.8124 12.9238 12.8029Z"
                fill="#00D6B9" />
              <path
                d="M9.09696 21.2986C14.0815 21.2986 18.4225 18.5476 20.6877 14.4843C20.7666 14.3423 20.8454 14.1972 20.918 14.052C20.8044 14.2729 20.6751 14.4811 20.5394 14.6767C20.4889 14.7461 20.4385 14.8155 20.388 14.8818C20.3217 14.9669 20.2555 15.049 20.1861 15.1278C20.1324 15.1909 20.0757 15.2509 20.0189 15.3108C19.9021 15.4307 19.7823 15.5474 19.6561 15.6547C19.5867 15.7146 19.5141 15.7714 19.4415 15.8282C19.3564 15.8944 19.268 15.9575 19.1797 16.0143C19.1229 16.0522 19.0661 16.09 19.0093 16.1247C18.9494 16.1626 18.8895 16.1973 18.8264 16.232C18.7002 16.3014 18.574 16.3645 18.4446 16.4245C18.3311 16.4749 18.2175 16.5223 18.1008 16.5633C17.9746 16.6106 17.8452 16.6516 17.7159 16.6863C17.5234 16.7399 17.3247 16.7809 17.1259 16.8125C16.9808 16.8346 16.8357 16.8504 16.6874 16.863C16.5328 16.8724 16.3751 16.8787 16.2173 16.8756C16.0438 16.8724 15.8703 16.863 15.6936 16.844C15.5643 16.8314 15.435 16.8125 15.3056 16.7873C15.192 16.7683 15.0785 16.7431 14.9649 16.7178C14.9049 16.7021 14.845 16.6895 14.7851 16.6737C14.6179 16.6295 14.4538 16.5822 14.2898 16.5349C14.2077 16.5096 14.1257 16.4875 14.0437 16.4623C13.9206 16.4245 13.7976 16.3897 13.6777 16.3519C13.5768 16.3203 13.479 16.2888 13.378 16.2572C13.2834 16.2257 13.1887 16.1942 13.0941 16.1626C13.031 16.1405 12.9647 16.1184 12.9016 16.0964C12.8228 16.0711 12.7471 16.0427 12.6682 16.0143C12.6114 15.9954 12.5578 15.9765 12.501 15.9544C12.3906 15.9134 12.2802 15.8755 12.1729 15.8345C12.1098 15.8093 12.0467 15.7872 11.9836 15.7619C11.8984 15.7304 11.8132 15.6957 11.7312 15.6641C11.6429 15.6294 11.5514 15.5947 11.4631 15.5569C11.4063 15.5348 11.3463 15.5096 11.2895 15.4875C11.217 15.4591 11.1476 15.4275 11.075 15.3991C11.0214 15.3771 10.9646 15.3518 10.911 15.3297C10.8542 15.3045 10.7974 15.2793 10.7406 15.254C10.6901 15.2319 10.6428 15.2099 10.5923 15.1878C10.5482 15.1688 10.5008 15.1468 10.4567 15.1278C10.4094 15.1057 10.3652 15.0868 10.3179 15.0647C10.2705 15.0427 10.2232 15.0206 10.1759 14.9985C10.116 14.9701 10.056 14.9417 9.99608 14.9165C9.93299 14.8881 9.87304 14.8565 9.80995 14.8281C9.7437 14.7966 9.67745 14.765 9.6112 14.7303C9.55441 14.7019 9.49762 14.6735 9.44084 14.6483C6.45324 13.1592 3.80321 11.1717 1.54438 8.76145C1.43081 8.64157 1.23206 8.72044 1.23206 8.88449L1.23836 18.0933C1.23836 18.494 1.43712 18.8726 1.77153 19.0934C3.86631 20.4878 6.38699 21.2986 9.09696 21.2986Z"
                fill="#3370FF" />
              <path
                d="M23.7322 9.29488C22.7226 8.79642 21.5838 8.5188 20.3818 8.5188C19.6688 8.5188 18.9747 8.6166 18.3217 8.80273C18.246 8.82481 18.1703 8.8469 18.0977 8.86898C18.0441 8.88476 17.9905 8.90368 17.94 8.91946C17.8359 8.95416 17.7318 8.99202 17.6276 9.03303C17.4447 9.10559 17.2617 9.18446 17.085 9.26964C16.8957 9.36113 16.7128 9.45893 16.5329 9.56619C16.35 9.67345 16.1701 9.79018 15.9998 9.91322C15.8767 10.0016 15.7569 10.093 15.637 10.1877C15.5076 10.2918 15.3846 10.3991 15.2616 10.5095C15.1953 10.5694 15.1322 10.6325 15.066 10.6925L14.7315 11.0206L13.3939 12.3424L13.1636 12.5696L13.0879 12.6453C13.05 12.6831 13.0122 12.7178 12.9775 12.7557C12.9586 12.7746 12.9396 12.7904 12.9207 12.8093C12.8923 12.8377 12.8639 12.863 12.8355 12.8882C12.804 12.9166 12.7724 12.9481 12.7409 12.9765C11.9143 13.7368 10.9931 14.3899 9.99304 14.923C10.053 14.9514 10.1129 14.9798 10.1729 15.0051C10.2202 15.0271 10.2675 15.0492 10.3148 15.0713C10.359 15.0934 10.4063 15.1123 10.4536 15.1344C10.4978 15.1533 10.5451 15.1754 10.5893 15.1943C10.6398 15.2164 10.6871 15.2385 10.7376 15.2606C10.7944 15.2858 10.8511 15.3111 10.9079 15.3363C10.9616 15.3584 11.0184 15.3836 11.072 15.4057C11.1445 15.4373 11.2139 15.4657 11.2865 15.4941C11.3433 15.5193 11.4032 15.5414 11.46 15.5635C11.5484 15.5982 11.6367 15.636 11.7282 15.6707C11.8134 15.7023 11.8954 15.737 11.9806 15.7685C12.0437 15.7938 12.1068 15.8158 12.1699 15.8411C12.2803 15.8821 12.3875 15.9231 12.498 15.961C12.5547 15.9799 12.6084 16.002 12.6652 16.0209C12.744 16.0493 12.8197 16.0745 12.8986 16.1029C12.9617 16.125 13.028 16.1471 13.0911 16.1692C13.1857 16.2007 13.2803 16.2323 13.375 16.2638C13.4728 16.2954 13.5737 16.3269 13.6747 16.3585C13.7977 16.3963 13.9176 16.4342 14.0406 16.4689C14.1227 16.4941 14.2047 16.5162 14.2867 16.5414C14.4508 16.5888 14.618 16.6361 14.782 16.6803C14.842 16.696 14.9019 16.7118 14.9618 16.7244C15.0754 16.7528 15.189 16.7749 15.3026 16.7938C15.4319 16.8159 15.5613 16.8348 15.6906 16.8506C15.8673 16.8695 16.0408 16.8822 16.2143 16.8822C16.372 16.8853 16.5298 16.879 16.6844 16.8695C16.8326 16.8601 16.9778 16.8412 17.1229 16.8191C17.3248 16.7875 17.5204 16.7465 17.7128 16.6929C17.8422 16.6582 17.9715 16.6172 18.0977 16.5698C18.2144 16.5257 18.328 16.4815 18.4416 16.4279C18.5709 16.3679 18.7003 16.3048 18.8233 16.2354C18.8833 16.2007 18.9464 16.166 19.0063 16.1282C19.0631 16.0935 19.1199 16.0556 19.1767 16.0178C19.265 15.9578 19.3533 15.8947 19.4385 15.8316C19.5111 15.7748 19.5836 15.718 19.653 15.6581C19.7792 15.5508 19.8991 15.4341 20.0158 15.3142C20.0726 15.2543 20.1294 15.1943 20.183 15.1313C20.2524 15.0524 20.3187 14.9704 20.3849 14.8852C20.4354 14.8189 20.4859 14.7495 20.5364 14.6801C20.672 14.4845 20.7982 14.2763 20.9118 14.0586L21.0411 13.7999L22.2084 11.4748L22.2053 11.4812C22.5807 10.6578 23.1012 9.91953 23.7322 9.29488Z"
                fill="#133C9A" />
            </svg>
            Feishu (Lark)
          </div>
          <div class="provider-desc">Sign in or authorize with specific scopes (calendar, docs, contacts, etc.)</div>
          <div class="input-group">
            <input type="text" id="feishu-app-id" placeholder="App ID (optional for demo)" />
            <div class="help-text">
              üîó <a href="https://open.feishu.cn/app" target="_blank">Create Feishu App</a><br>
              üìã Redirect URL: <code>http://localhost:8000/examples/callback-local.html</code>
            </div>
          </div>
          <div class="input-group">
            <input type="text" id="feishu-scopes"
              placeholder="Scopes (optional): calendar:readonly contact:user.base:readonly" />
            <div class="help-text">
              üí° Leave empty for login only, or add scopes for authorization
            </div>
          </div>
          <button id="feishu-btn" class="feishu-btn" onclick="loginWithFeishu()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M12.9238 12.8029C12.9427 12.784 12.9616 12.7682 12.9806 12.7493C13.0184 12.7146 13.0563 12.6767 13.091 12.6389L13.1667 12.5631L13.397 12.336L14.7315 11.0173L15.0659 10.686C15.129 10.6229 15.1952 10.563 15.2615 10.5031C15.3845 10.3926 15.5076 10.2854 15.6369 10.1813C15.7536 10.0866 15.8767 9.99514 15.9997 9.9068C16.1732 9.78376 16.3499 9.67019 16.5329 9.55977C16.7127 9.45251 16.8957 9.35471 17.085 9.26322C17.2616 9.17804 17.4415 9.09917 17.6276 9.02661C17.7317 8.9856 17.8326 8.94774 17.9399 8.91304C17.9935 8.89411 18.044 8.87834 18.0977 8.86256C17.6276 7.00439 16.7632 5.3008 15.5991 3.84959C15.3719 3.56566 15.0249 3.40161 14.6589 3.40161H5.0084C4.83489 3.40161 4.76233 3.6256 4.90114 3.72656C8.18528 6.13997 10.9236 9.24114 12.9017 12.825C12.908 12.8187 12.9175 12.8124 12.9238 12.8029Z"
                fill="white" />
              <path
                d="M9.09696 21.2986C14.0815 21.2986 18.4225 18.5476 20.6877 14.4843C20.7666 14.3423 20.8454 14.1972 20.918 14.052C20.8044 14.2729 20.6751 14.4811 20.5394 14.6767C20.4889 14.7461 20.4385 14.8155 20.388 14.8818C20.3217 14.9669 20.2555 15.049 20.1861 15.1278C20.1324 15.1909 20.0757 15.2509 20.0189 15.3108C19.9021 15.4307 19.7823 15.5474 19.6561 15.6547C19.5867 15.7146 19.5141 15.7714 19.4415 15.8282C19.3564 15.8944 19.268 15.9575 19.1797 16.0143C19.1229 16.0522 19.0661 16.09 19.0093 16.1247C18.9494 16.1626 18.8895 16.1973 18.8264 16.232C18.7002 16.3014 18.574 16.3645 18.4446 16.4245C18.3311 16.4749 18.2175 16.5223 18.1008 16.5633C17.9746 16.6106 17.8452 16.6516 17.7159 16.6863C17.5234 16.7399 17.3247 16.7809 17.1259 16.8125C16.9808 16.8346 16.8357 16.8504 16.6874 16.863C16.5328 16.8724 16.3751 16.8787 16.2173 16.8756C16.0438 16.8724 15.8703 16.863 15.6936 16.844C15.5643 16.8314 15.435 16.8125 15.3056 16.7873C15.192 16.7683 15.0785 16.7431 14.9649 16.7178C14.9049 16.7021 14.845 16.6895 14.7851 16.6737C14.6179 16.6295 14.4538 16.5822 14.2898 16.5349C14.2077 16.5096 14.1257 16.4875 14.0437 16.4623C13.9206 16.4245 13.7976 16.3897 13.6777 16.3519C13.5768 16.3203 13.479 16.2888 13.378 16.2572C13.2834 16.2257 13.1887 16.1942 13.0941 16.1626C13.031 16.1405 12.9647 16.1184 12.9016 16.0964C12.8228 16.0711 12.7471 16.0427 12.6682 16.0143C12.6114 15.9954 12.5578 15.9765 12.501 15.9544C12.3906 15.9134 12.2802 15.8755 12.1729 15.8345C12.1098 15.8093 12.0467 15.7872 11.9836 15.7619C11.8984 15.7304 11.8132 15.6957 11.7312 15.6641C11.6429 15.6294 11.5514 15.5947 11.4631 15.5569C11.4063 15.5348 11.3463 15.5096 11.2895 15.4875C11.217 15.4591 11.1476 15.4275 11.075 15.3991C11.0214 15.3771 10.9646 15.3518 10.911 15.3297C10.8542 15.3045 10.7974 15.2793 10.7406 15.254C10.6901 15.2319 10.6428 15.2099 10.5923 15.1878C10.5482 15.1688 10.5008 15.1468 10.4567 15.1278C10.4094 15.1057 10.3652 15.0868 10.3179 15.0647C10.2705 15.0427 10.2232 15.0206 10.1759 14.9985C10.116 14.9701 10.056 14.9417 9.99608 14.9165C9.93299 14.8881 9.87304 14.8565 9.80995 14.8281C9.7437 14.7966 9.67745 14.765 9.6112 14.7303C9.55441 14.7019 9.49762 14.6735 9.44084 14.6483C6.45324 13.1592 3.80321 11.1717 1.54438 8.76145C1.43081 8.64157 1.23206 8.72044 1.23206 8.88449L1.23836 18.0933C1.23836 18.494 1.43712 18.8726 1.77153 19.0934C3.86631 20.4878 6.38699 21.2986 9.09696 21.2986Z"
                fill="white" />
              <path
                d="M23.7322 9.29488C22.7226 8.79642 21.5838 8.5188 20.3818 8.5188C19.6688 8.5188 18.9747 8.6166 18.3217 8.80273C18.246 8.82481 18.1703 8.8469 18.0977 8.86898C18.0441 8.88476 17.9905 8.90368 17.94 8.91946C17.8359 8.95416 17.7318 8.99202 17.6276 9.03303C17.4447 9.10559 17.2617 9.18446 17.085 9.26964C16.8957 9.36113 16.7128 9.45893 16.5329 9.56619C16.35 9.67345 16.1701 9.79018 15.9998 9.91322C15.8767 10.0016 15.7569 10.093 15.637 10.1877C15.5076 10.2918 15.3846 10.3991 15.2616 10.5095C15.1953 10.5694 15.1322 10.6325 15.066 10.6925L14.7315 11.0206L13.3939 12.3424L13.1636 12.5696L13.0879 12.6453C13.05 12.6831 13.0122 12.7178 12.9775 12.7557C12.9586 12.7746 12.9396 12.7904 12.9207 12.8093C12.8923 12.8377 12.8639 12.863 12.8355 12.8882C12.804 12.9166 12.7724 12.9481 12.7409 12.9765C11.9143 13.7368 10.9931 14.3899 9.99304 14.923C10.053 14.9514 10.1129 14.9798 10.1729 15.0051C10.2202 15.0271 10.2675 15.0492 10.3148 15.0713C10.359 15.0934 10.4063 15.1123 10.4536 15.1344C10.4978 15.1533 10.5451 15.1754 10.5893 15.1943C10.6398 15.2164 10.6871 15.2385 10.7376 15.2606C10.7944 15.2858 10.8511 15.3111 10.9079 15.3363C10.9616 15.3584 11.0184 15.3836 11.072 15.4057C11.1445 15.4373 11.2139 15.4657 11.2865 15.4941C11.3433 15.5193 11.4032 15.5414 11.46 15.5635C11.5484 15.5982 11.6367 15.636 11.7282 15.6707C11.8134 15.7023 11.8954 15.737 11.9806 15.7685C12.0437 15.7938 12.1068 15.8158 12.1699 15.8411C12.2803 15.8821 12.3875 15.9231 12.498 15.961C12.5547 15.9799 12.6084 16.002 12.6652 16.0209C12.744 16.0493 12.8197 16.0745 12.8986 16.1029C12.9617 16.125 13.028 16.1471 13.0911 16.1692C13.1857 16.2007 13.2803 16.2323 13.375 16.2638C13.4728 16.2954 13.5737 16.3269 13.6747 16.3585C13.7977 16.3963 13.9176 16.4342 14.0406 16.4689C14.1227 16.4941 14.2047 16.5162 14.2867 16.5414C14.4508 16.5888 14.618 16.6361 14.782 16.6803C14.842 16.696 14.9019 16.7118 14.9618 16.7244C15.0754 16.7528 15.189 16.7749 15.3026 16.7938C15.4319 16.8159 15.5613 16.8348 15.6906 16.8506C15.8673 16.8695 16.0408 16.8822 16.2143 16.8822C16.372 16.8853 16.5298 16.879 16.6844 16.8695C16.8326 16.8601 16.9778 16.8412 17.1229 16.8191C17.3248 16.7875 17.5204 16.7465 17.7128 16.6929C17.8422 16.6582 17.9715 16.6172 18.0977 16.5698C18.2144 16.5257 18.328 16.4815 18.4416 16.4279C18.5709 16.3679 18.7003 16.3048 18.8233 16.2354C18.8833 16.2007 18.9464 16.166 19.0063 16.1282C19.0631 16.0935 19.1199 16.0556 19.1767 16.0178C19.265 15.9578 19.3533 15.8947 19.4385 15.8316C19.5111 15.7748 19.5836 15.718 19.653 15.6581C19.7792 15.5508 19.8991 15.4341 20.0158 15.3142C20.0726 15.2543 20.1294 15.1943 20.183 15.1313C20.2524 15.0524 20.3187 14.9704 20.3849 14.8852C20.4354 14.8189 20.4859 14.7495 20.5364 14.6801C20.672 14.4845 20.7982 14.2763 20.9118 14.0586L21.0411 13.7999L22.2084 11.4748L22.2053 11.4812C22.5807 10.6578 23.1012 9.91953 23.7322 9.29488Z"
                fill="white" />
            </svg>
            <span>Connect</span>
          </button>
        </div>

        <!-- Google Provider -->
        <div class="provider-card">
          <div class="provider-name">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                fill="#4285F4" />
              <path
                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                fill="#34A853" />
              <path
                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                fill="#FBBC05" />
              <path
                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                fill="#EA4335" />
            </svg>
            Google
          </div>
          <div class="provider-desc">Sign in with your Google account</div>
          <div class="input-group">
            <input type="text" id="google-client-id" placeholder="Client ID (optional for demo)" />
            <div class="help-text">
              üîó <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Create OAuth Client</a><br>
              üìã Redirect URI: <code>http://localhost:8000/examples/callback-local.html</code>
            </div>
          </div>
          <button id="google-btn" class="google-btn" onclick="loginWithGoogle()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path
                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                fill="white" />
              <path
                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                fill="white" />
              <path
                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                fill="white" />
              <path
                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                fill="white" />
            </svg>
            <span>Sign in</span>
          </button>
        </div>
      </div>
    </div>

    <div id="result" class="result"></div>

    <div class="info-section">
      <div class="section-heading">
        <svg viewBox="0 0 16 16" fill="currentColor">
          <path
            d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1Zm0 1.5a5.5 5.5 0 1 1 0 11 5.5 5.5 0 0 1 0-11Zm.75 2.75a.75.75 0 0 0-1.5 0v2.5h-2a.75.75 0 0 0 0 1.5h2v2a.75.75 0 0 0 1.5 0v-2h2a.75.75 0 0 0 0-1.5h-2v-2.5Z">
          </path>
        </svg>
        How it works
      </div>
      <div class="features-grid">
        <div class="feature-card">
          <div class="feature-icon">
            <svg viewBox="0 0 16 16" fill="currentColor">
              <path
                d="M8.75 1a.75.75 0 0 0-1.5 0v2.5h-2a.75.75 0 0 0 0 1.5h2v2a.75.75 0 0 0 1.5 0v-2h2a.75.75 0 0 0 0-1.5h-2V1ZM1.75 9a.75.75 0 0 1 .75-.75h11a.75.75 0 0 1 0 1.5h-11A.75.75 0 0 1 1.75 9Zm0 3a.75.75 0 0 1 .75-.75h11a.75.75 0 0 1 0 1.5h-11a.75.75 0 0 1-.75-.75Z">
              </path>
            </svg>
          </div>
          <div class="feature-title">Real OAuth Flow</div>
          <div class="feature-desc">Enter your real App ID to test live production authorization with actual provider
            data.</div>
        </div>
        <div class="feature-card">
          <div class="feature-icon">
            <svg viewBox="0 0 16 16" fill="currentColor">
              <path
                d="M6 3.5A1.5 1.5 0 0 1 7.5 2h1A1.5 1.5 0 0 1 10 3.5v1A1.5 1.5 0 0 1 8.5 6h-1A1.5 1.5 0 0 1 6 4.5v-1zM7.5 3a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zM4.5 8a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zM3 8.5A1.5 1.5 0 0 1 4.5 7h1A1.5 1.5 0 0 1 7 8.5v1A1.5 1.5 0 0 1 5.5 11h-1A1.5 1.5 0 0 1 3 9.5v-1zM10 8.5A1.5 1.5 0 0 1 11.5 7h1A1.5 1.5 0 0 1 14 8.5v1a1.5 1.5 0 0 1-1.5 1.5h-1A1.5 1.5 0 0 1 10 9.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1z">
              </path>
            </svg>
          </div>
          <div class="feature-title">Demo Mode</div>
          <div class="feature-desc">Leave fields empty to experience the simulated flow and see how UI handles
            responses.</div>
        </div>
        <div class="feature-card">
          <div class="feature-icon">
            <svg viewBox="0 0 16 16" fill="currentColor">
              <path
                d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm9.78-2.22-5.5 5.5a.75.75 0 0 1-1.06 0l-2.5-2.5a.75.75 0 1 1 1.06-1.06L5.5 9.94l4.97-4.97a.75.75 0 0 1 1.06 1.06Z">
              </path>
            </svg>
          </div>
          <div class="feature-title">Secure by Design</div>
          <div class="feature-desc">Built-in PKCE support and mandatory state parameters prevent CSRF and code
            injection.</div>
        </div>
        <div class="feature-card">
          <div class="feature-icon">
            <svg viewBox="0 0 16 16" fill="currentColor">
              <path
                d="M1.5 3.25c0-.966.784-1.75 1.75-1.75h9.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 12.75 13h-9.5A1.75 1.75 0 0 1 1.5 11.75v-8.5Zm1.75-.25a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25v-8.5a.25.25 0 0 0-.25-.25h-9.5ZM5 6.25a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 0 1.5h-4.5A.75.75 0 0 1 5 6.25Zm.75 2.25a.75.75 0 0 0 0 1.5h2.5a.75.75 0 0 0 0-1.5h-2.5Z">
              </path>
            </svg>
          </div>
          <div class="feature-title">Multiple Providers</div>
          <div class="feature-desc">One library to rule them all. Unified API for GitHub, Google, Slack, Feishu, and
            more.</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { AuthPopup, generatePKCE, generateState } from '../dist/auth-popup.js';

    // Demo user data for GitHub
    const demoUserGitHub = {
      login: 'octocat',
      name: 'The Octocat',
      avatar_url: 'https://avatars.githubusercontent.com/u/583231?v=4',
      bio: 'GitHub mascot and demo user'
    };

    // Demo user data for Feishu
    const demoUserFeishu = {
      login: 'feishu_user',
      name: 'È£û‰π¶Áî®Êà∑',
      avatar_url: 'https://sf3-scmcdn-cn.feishucdn.com/obj/static/lark/passport/img/avatar-default_v3.png',
      bio: 'Feishu demo user'
    };

    // Demo user data for Google
    const demoUserGoogle = {
      login: 'google_user',
      name: 'Google User',
      avatar_url: 'https://lh3.googleusercontent.com/a/default-user',
      bio: 'Google demo user'
    };

    // Show user card
    function showUserCard(user) {
      return `
        <div class="user-card">
          <img class="user-avatar" src="${user.avatar_url}" alt="${user.name || user.login}" />
          <div class="user-info">
            <div class="user-name">${user.name || user.login}</div>
            <div class="user-login">@${user.login}</div>
            ${user.bio ? `<div class="user-bio">${user.bio}</div>` : ''}
          </div>
        </div>
      `;
    }

    // Show result with user card
    function showResult(success, message, data, user = null) {
      const resultDiv = document.getElementById('result');

      let contentHtml = '';

      if (success && user) {
        // Show user card on left and JSON on right
        contentHtml = `
          <div class="result-layout">
            ${showUserCard(user)}
              <div class="result-content">${JSON.stringify(data, null, 2)}</div>
          </div>
        `;
      } else if (success && !user && data?.mode === 'real') {
        // Real OAuth without backend: show next steps
        contentHtml = `
          <div class="next-steps">
            <strong>üîê Next steps to get user info:</strong><br>
            1. Send <code>code</code> to your backend<br>
            2. Exchange code for access_token using <code>client_secret</code><br>
            3. Call <code>GET /user</code> API with access_token<br>
            4. Display user's name and avatar<br><br>
            üí° <strong>Tip:</strong> Run server with credentials to see real user info:<br>
            <code>GITHUB_CLIENT_ID=xxx GITHUB_CLIENT_SECRET=xxx npm start</code><br>
            <code>FEISHU_APP_ID=xxx FEISHU_APP_SECRET=xxx npm start</code>
          </div>
          ${data ? '<div class="result-content">' + JSON.stringify(data, null, 2) + '</div>' : ''}
        `;
      } else {
        // Error or other cases - always show message
        contentHtml = `<div class="result-message">${message}</div>`;
        if (data) {
          contentHtml += '<div class="result-content">' + JSON.stringify(data, null, 2) + '</div>';
        }
      }

      resultDiv.className = `result show ${success ? 'success' : 'error'}`;
      resultDiv.innerHTML = `
        <div class="result-title">
          ${success ? '‚úì Authorization successful' : '‚úó Authorization failed'}
        </div>
        ${contentHtml}
      `;
    }

    // Set loading state
    function setLoading(button, loading) {
      if (loading) {
        button.disabled = true;
        const span = button.querySelector('span');
        span.innerHTML = '<div class="spinner"></div> Authorizing...';
      } else {
        button.disabled = false;
      }
    }

    // GitHub login
    window.loginWithGitHub = async function () {
      const button = document.getElementById('github-btn');
      setLoading(button, true);

      try {
        // Generate PKCE and state
        const pkce = await generatePKCE();
        const state = generateState();

        sessionStorage.setItem('code_verifier', pkce.codeVerifier);
        sessionStorage.setItem('state', state);

        // Check if Client ID is provided
        const clientIdInput = document.getElementById('github-client-id');
        const clientId = clientIdInput.value.trim();

        let authUrl;

        if (clientId) {
          // Real GitHub OAuth flow
          authUrl = new URL('https://github.com/login/oauth/authorize');
          authUrl.searchParams.set('client_id', clientId);
          authUrl.searchParams.set('redirect_uri', window.location.origin + '/examples/callback-local.html');
          authUrl.searchParams.set('scope', 'user:email');
          authUrl.searchParams.set('state', state);
          authUrl.searchParams.set('response_type', 'code');

          console.log('üöÄ Using real GitHub OAuth:', authUrl.toString());
        } else {
          // Demo mode
          authUrl = new URL(window.location.origin + '/examples/callback-local.html');
          authUrl.searchParams.set('code', 'gho_demo_' + Math.random().toString(36).substring(2, 18));
          authUrl.searchParams.set('state', state);

          console.log('üé≠ Using demo mode');
        }

        const result = await AuthPopup.open({
          authUrl: authUrl.toString(),
          width: 600,
          height: 700,
          timeout: 60000,
        });

        // Verify state
        if (result.state !== state) {
          throw new Error('State verification failed');
        }

        const isDemo = !clientId;

        if (isDemo) {
          // Demo mode: show simulated user
          showResult(
            true,
            'Demo authorization completed! Here is a simulated user:',
            {
              code: result.code,
              state: result.state,
              mode: 'demo',
            },
            demoUserGitHub
          );
        } else {
          // Real OAuth: try to fetch user from backend
          try {
            // Step 1: Exchange code for token
            const tokenRes = await fetch('/api/github/token', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ code: result.code }),
            });

            if (!tokenRes.ok) {
              const err = await tokenRes.json();
              throw new Error(err.error_description || 'Token exchange failed');
            }

            const tokenData = await tokenRes.json();

            // Step 2: Get user info
            const userRes = await fetch('/api/github/user', {
              headers: { 'Authorization': `Bearer ${tokenData.access_token}` },
            });

            if (!userRes.ok) {
              const err = await userRes.json();
              throw new Error(err.error_description || 'Failed to get user');
            }

            const user = await userRes.json();

            showResult(
              true,
              `Welcome, ${user.name || user.login}! üéâ`,
              {
                code: result.code,
                state: result.state,
                mode: 'real',
                access_token: tokenData.access_token.substring(0, 10) + '...',
              },
              user
            );
          } catch (apiError) {
            // Backend not available, show manual steps
            console.warn('Backend API not available:', apiError.message);
            showResult(
              true,
              'Authorization code received! Backend API not available.',
              {
                code: result.code,
                state: result.state,
                mode: 'real',
              },
              null
            );
          }
        }
      } catch (error) {
        showResult(false, error.message);
      } finally {
        setLoading(button, false);
        // Restore button text
        setTimeout(() => {
          const span = button.querySelector('span');
          span.textContent = 'Sign in with GitHub';
        }, 100);
      }
    };

    // Feishu login/authorization
    window.loginWithFeishu = async function () {
      const button = document.getElementById('feishu-btn');
      setLoading(button, true);

      try {
        // Generate state
        const state = generateState();
        sessionStorage.setItem('state', state);

        // Check if App ID is provided
        const appIdInput = document.getElementById('feishu-app-id');
        const appId = appIdInput.value.trim();
        const scopesInput = document.getElementById('feishu-scopes');
        const scopes = scopesInput.value.trim();

        let authUrl;

        if (appId) {
          // Real Feishu OAuth flow
          authUrl = new URL('https://open.feishu.cn/open-apis/authen/v1/authorize');
          authUrl.searchParams.set('app_id', appId);
          authUrl.searchParams.set('redirect_uri', window.location.origin + '/examples/callback-local.html');
          authUrl.searchParams.set('state', state);

          // Add scopes if provided
          if (scopes) {
            authUrl.searchParams.set('scope', scopes);
          }

          console.log('üöÄ Using real Feishu OAuth' + (scopes ? ' with scopes' : '') + ':', authUrl.toString());
        } else {
          // Demo mode
          authUrl = new URL(window.location.origin + '/examples/callback-local.html');
          authUrl.searchParams.set('code', 'feishu_demo_' + Math.random().toString(36).substring(2, 18));
          authUrl.searchParams.set('state', state);

          console.log('üé≠ Using demo mode for Feishu' + (scopes ? ' with scopes' : ''));
        }

        const result = await AuthPopup.open({
          authUrl: authUrl.toString(),
          width: 600,
          height: 700,
          timeout: 60000,
        });

        // Verify state
        if (result.state !== state) {
          throw new Error('State verification failed');
        }

        const isDemo = !appId;
        const hasScopes = !!scopes;

        if (isDemo) {
          // Demo mode: show simulated user
          const demoData = {
            code: result.code,
            state: result.state,
            mode: 'demo',
            provider: 'feishu',
          };

          if (hasScopes) {
            demoData.type = 'authorization';
            demoData.scopes_requested = scopes;
            demoData.scopes_granted = ['calendar:readonly', 'contact:user.base:readonly'];
          }

          const demoUser = {
            login: 'feishu_user',
            name: 'È£û‰π¶' + (hasScopes ? '‰ºÅ‰∏ö' : '') + 'Áî®Êà∑',
            avatar_url: 'https://sf3-scmcdn-cn.feishucdn.com/obj/static/lark/passport/img/avatar-default_v3.png',
            bio: hasScopes ? `Authorized scopes: ${scopes}` : 'Feishu demo user',
          };

          showResult(
            true,
            'Demo ' + (hasScopes ? 'authorization' : 'login') + ' completed!',
            demoData,
            demoUser
          );
        } else {
          // Real OAuth: try to fetch user from backend
          try {
            // Step 1: Exchange code for token
            const tokenRes = await fetch('/api/feishu/token', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ code: result.code }),
            });

            if (!tokenRes.ok) {
              const err = await tokenRes.json();
              throw new Error(err.error_description || err.message || 'Token exchange failed');
            }

            const tokenData = await tokenRes.json();

            // Step 2: Get user info
            const userRes = await fetch('/api/feishu/user', {
              headers: { 'Authorization': `Bearer ${tokenData.access_token}` },
            });

            if (!userRes.ok) {
              const err = await userRes.json();
              throw new Error(err.error_description || err.message || 'Failed to get user');
            }

            const userData = await userRes.json();

            // Normalize Feishu user data to common format
            const user = {
              login: userData.open_id || userData.user_id,
              name: userData.name,
              avatar_url: userData.avatar_url || userData.avatar_big,
              bio: hasScopes ? `Authorized: ${scopes}` : (userData.enterprise_email || userData.mobile),
            };

            const resultData = {
              code: result.code,
              state: result.state,
              mode: 'real',
              provider: 'feishu',
              access_token: tokenData.access_token.substring(0, 10) + '...',
            };

            if (hasScopes) {
              resultData.type = 'authorization';
              resultData.scopes_requested = scopes;
              resultData.token_type = tokenData.token_type || 'Bearer';
              resultData.expires_in = tokenData.expires_in;
            }

            showResult(
              true,
              `Welcome, ${user.name}! üéâ`,
              resultData,
              user
            );
          } catch (apiError) {
            // Backend not available, show manual steps
            console.warn('Backend API not available:', apiError.message);
            showResult(
              true,
              'Authorization code received! Backend API not available.',
              {
                code: result.code,
                state: result.state,
                mode: 'real',
                provider: 'feishu',
                type: hasScopes ? 'authorization' : 'login',
                scopes_requested: scopes || undefined,
              },
              null
            );
          }
        }
      } catch (error) {
        showResult(false, error.message);
      } finally {
        setLoading(button, false);
        // Restore button text
        setTimeout(() => {
          const span = button.querySelector('span');
          span.textContent = 'Connect';
        }, 100);
      }
    };

    // Google login
    window.loginWithGoogle = async function () {
      const button = document.getElementById('google-btn');
      setLoading(button, true);

      try {
        // Generate PKCE and state
        const pkce = await generatePKCE();
        const state = generateState();

        sessionStorage.setItem('code_verifier', pkce.codeVerifier);
        sessionStorage.setItem('state', state);

        // Check if Client ID is provided
        const clientIdInput = document.getElementById('google-client-id');
        const clientId = clientIdInput.value.trim();

        let authUrl;

        if (clientId) {
          // Real Google OAuth flow
          authUrl = new URL('https://accounts.google.com/o/oauth2/v2/auth');
          authUrl.searchParams.set('client_id', clientId);
          authUrl.searchParams.set('redirect_uri', window.location.origin + '/examples/callback-local.html');
          authUrl.searchParams.set('response_type', 'code');
          authUrl.searchParams.set('scope', 'openid email profile');
          authUrl.searchParams.set('state', state);
          authUrl.searchParams.set('code_challenge', pkce.codeChallenge);
          authUrl.searchParams.set('code_challenge_method', 'S256');

          console.log('üöÄ Using real Google OAuth:', authUrl.toString());
        } else {
          // Demo mode
          authUrl = new URL(window.location.origin + '/examples/callback-local.html');
          authUrl.searchParams.set('code', 'google_demo_' + Math.random().toString(36).substring(2, 18));
          authUrl.searchParams.set('state', state);

          console.log('üé≠ Using demo mode for Google');
        }

        const result = await AuthPopup.open({
          authUrl: authUrl.toString(),
          width: 600,
          height: 700,
          timeout: 60000,
        });

        // Verify state
        if (result.state !== state) {
          throw new Error('State verification failed');
        }

        const isDemo = !clientId;

        if (isDemo) {
          // Demo mode: show simulated user
          showResult(
            true,
            'Demo authorization completed! Here is a simulated user:',
            {
              code: result.code,
              state: result.state,
              mode: 'demo',
              provider: 'google',
            },
            demoUserGoogle
          );
        } else {
          // Real OAuth: try to fetch user from backend
          try {
            // Get code_verifier from sessionStorage
            const codeVerifier = sessionStorage.getItem('code_verifier');

            // Step 1: Exchange code for token
            const tokenRes = await fetch('/api/google/token', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                code: result.code,
                code_verifier: codeVerifier
              }),
            });

            if (!tokenRes.ok) {
              const err = await tokenRes.json();
              throw new Error(err.error_description || err.error || 'Token exchange failed');
            }

            const tokenData = await tokenRes.json();

            // Step 2: Get user info
            const userRes = await fetch('/api/google/user', {
              headers: { 'Authorization': `Bearer ${tokenData.access_token}` },
            });

            if (!userRes.ok) {
              const err = await userRes.json();
              throw new Error(err.error_description || err.error || 'Failed to get user');
            }

            const user = await userRes.json();

            showResult(
              true,
              `Welcome, ${user.name}! üéâ`,
              {
                code: result.code,
                state: result.state,
                mode: 'real',
                provider: 'google',
                access_token: tokenData.access_token.substring(0, 10) + '...',
              },
              user
            );
          } catch (apiError) {
            // Backend not available, show manual steps with detailed error
            console.error('Backend API error:', apiError);
            showResult(
              true,
              'Authorization code received! Backend error: ' + apiError.message,
              {
                code: result.code,
                state: result.state,
                mode: 'real',
                provider: 'google',
                error_detail: apiError.message,
              },
              null
            );
          }
        }
      } catch (error) {
        showResult(false, 'Google OAuth Error: ' + error.message);
      } finally {
        setLoading(button, false);
        // Restore button text
        setTimeout(() => {
          const span = button.querySelector('span');
          span.textContent = 'Sign in';
        }, 100);
      }
    };
  </script>
</body>

</html>